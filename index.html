<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.23.0/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

    <script>
    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 300 }
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var game = new Phaser.Game(config);
    var cells = [];
    var numRows = 9;
    var numCols = 9;
    var numMines = 10;
    var cellValues = [];

    function preload ()
    {
        this.load.setBaseURL('https://raw.githubusercontent.com');
        this.load.atlas('atlas',
                        'karstendick/minej/master/assets/minesweeper-atlas.png',
                        'karstendick/minej/master/assets/minesweeper-atlas.json')
    }

    function cellPointerDown(pointer)
    {
        if (pointer.leftButtonDown())
        {
            if (this.getData("isFlagged"))
                return;
            console.log("pointerdown event at (", this.getData('row'), ", ", this.getData('col'), ")");
            this.setFrame('cell-empty');
        }
    }

    function cellPointerOut(pointer)
    {
        // console.log("pointerout event at (", this.getData('row'), ", ", this.getData('col'), ")");
        // this.setFrame('cell-raised');
    }

    function cellPointerUp(pointer)
    {
        if (pointer.leftButtonReleased())
        {
            if (this.getData("isRevealed"))
                return;
            if (this.getData("isFlagged"))
                return; // TODO: What if there's an incorrectly flagged cell?
            this.setData("isRevealed", true);
            this.removeInteractive();
            console.log("pointerup event at (", this.getData('row'), ", ", this.getData('col'), ")");
            if (this.getData('isMine'))
            {
                this.setFrame('cell-detonated-bomb')
                // TODO: game over! Reveal board, stop timer, deactivate all cells, etc.
            } else if (this.getData('numNeighbors') == 0)
            {
                this.setFrame('cell-empty')
                // TODO: Reveal all neighboring cells
            } else
            {
                this.setFrame('cell' + this.getData('numNeighbors'))
            }
            // TODO: Check to see if you won
        } else if (pointer.rightButtonReleased())
        {
            if(this.getData("isFlagged"))
            {
                this.setFrame('cell-raised')
                this.setData("isFlagged", false)
            } else
            {
                this.setFrame('cell-flagged')
                this.setData("isFlagged", true)
            }
        }
    }

    function getCell(row, col)
    {
        if ((0 <= row) && (row < numRows) && (0 <= col) && (col < numCols))
        {
            return cells[row][col];
        }
        return undefined;
    }

    function getNeighbors(row, col)
    {
        neighbors = [
            getCell(row-1, col),
            getCell(row-1, col+1),
            getCell(row, col+1),
            getCell(row+1, col+1),
            getCell(row+1, col),
            getCell(row+1, col-1),
            getCell(row, col-1),
            getCell(row-1, col-1)
        ];
        neighbors = neighbors.filter(function(neighbor) {
            return neighbor !== undefined;
        });
        return neighbors;
    }

    function create ()
    {
        this.input.mouse.disableContextMenu();

        cellValues = new Array(numRows * numCols);
        cellValues.fill(false);
        cellValues.fill(true, 0, numMines);
        Phaser.Utils.Array.Shuffle(cellValues);

        for(var r = 0; r < numRows; ++r)
        {
            cells[r] = [];
            for(var c = 0; c < numCols; ++c)
            {
                var pxx = c * 16;
                var pxy = r * 16;
                var cell = this.add.image(pxx, pxy, 'atlas', 'cell-raised').setOrigin(0);

                cell.setData('row', r);
                cell.setData('col', c);
                cell.setData('isMine', cellValues[r * numRows + c]);
                cell.setData('isFlagged', false);
                cell.setData('isRevealed', false);

                cell.setInteractive();
                cell.on('pointerdown', cellPointerDown);
                cell.on('pointerout', cellPointerOut);
                cell.on('pointerup', cellPointerUp);

                cells[r][c] = cell;
            }
        }
        for(var r = 0; r < numRows; ++r)
        {
            for(var c = 0; c < numCols; ++c)
            {
                neighbors = getNeighbors(r,c);
                numNeighbors = neighbors.filter(function(neighbor) {
                    return neighbor.getData('isMine');
                }).length;
                cells[r][c].setData('numNeighbors', numNeighbors);
            }
        }
    }

    function update ()
    {
        
    }


    </script>

</body>
</html>